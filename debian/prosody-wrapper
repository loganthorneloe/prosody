#!/bin/bash
# Wrapper script for Prosody that ensures Whisper dependencies are installed

FIRST_RUN_FLAG="$HOME/.config/prosody/.first_run_complete"
ENABLE_FLAG="$HOME/.config/prosody/.enable-on-login"
VENV_DIR="$HOME/.local/share/prosody/venv"

# Create config directory
mkdir -p "$HOME/.config/prosody"
mkdir -p "$HOME/.local/share/prosody"

# Enable service on first login if flag exists
if [ -f "$ENABLE_FLAG" ]; then
    systemctl --user daemon-reload 2>/dev/null || true
    systemctl --user enable prosody.service 2>/dev/null || true
    rm -f "$ENABLE_FLAG"
fi

# Check if this is first run
if [ ! -f "$FIRST_RUN_FLAG" ]; then
    echo "First run detected. Setting up Prosody..."
    echo "This will download the Whisper model and dependencies (~2GB)."
    echo ""
    
    # Create a virtual environment for heavy dependencies
    python3 -m venv "$VENV_DIR"
    
    # Install Whisper and dependencies in venv
    echo "Installing speech recognition dependencies..."
    "$VENV_DIR/bin/pip" install --upgrade pip wheel
    
    # Install all required dependencies
    "$VENV_DIR/bin/pip" install numpy sounddevice pynput openai-whisper torch torchaudio --extra-index-url https://download.pytorch.org/whl/cpu
    
    # Create first run flag
    touch "$FIRST_RUN_FLAG"
    
    echo ""
    echo "Setup complete! Starting Prosody..."
    echo ""
fi

# Run Prosody with the venv Python if it exists, otherwise system Python
if [ -f "$VENV_DIR/bin/python" ]; then
    exec "$VENV_DIR/bin/python" -m prosody "$@"
else
    exec python3 -m prosody "$@"
fi