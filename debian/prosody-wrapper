#!/bin/bash
# Wrapper script for Prosody that ensures Whisper dependencies are installed

FIRST_RUN_FLAG="$HOME/.config/prosody/.first_run_complete"
ENABLE_FLAG="$HOME/.config/prosody/.enable-on-login"

# Create config directory
mkdir -p "$HOME/.config/prosody"
mkdir -p "$HOME/.local/share/prosody"

# Enable service on first login if flag exists
if [ -f "$ENABLE_FLAG" ]; then
    systemctl --user daemon-reload 2>/dev/null || true
    systemctl --user enable prosody.service 2>/dev/null || true
    rm -f "$ENABLE_FLAG"
fi

# Check if this is first run
if [ ! -f "$FIRST_RUN_FLAG" ]; then
    echo "First run detected. Setting up Prosody..."
    echo "This will download the Whisper model and dependencies (~2GB)."
    echo ""
    
    # Install dependencies in user's local Python
    echo "Installing speech recognition dependencies..."
    python3 -m pip install --user --upgrade pip wheel
    python3 -m pip install --user numpy sounddevice pynput openai-whisper torch torchaudio --extra-index-url https://download.pytorch.org/whl/cpu
    
    # Create first run flag
    touch "$FIRST_RUN_FLAG"
    
    echo ""
    echo "Setup complete! Starting Prosody..."
    echo ""
fi

# Run Prosody with system Python
exec python3 -m prosody "$@"