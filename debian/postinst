#!/bin/bash
set -e

case "$1" in
    configure)
        # Create system user for prosody if needed (optional)
        # For now, we run as the regular user
        
        # Ensure python3-pip is available
        if ! command -v pip3 &> /dev/null; then
            echo "Installing pip3..."
            apt-get update
            apt-get install -y python3-pip
        fi
        
        # Install Python package in system
        pip3 install --system /usr/share/prosody-stt/ || true
        
        # Enable auto-start for all users
        echo "Enabling auto-start for Prosody..."
        
        # Create systemd user service directory if it doesn't exist
        mkdir -p /etc/systemd/user/
        
        # Copy service file to system location
        cp /usr/share/prosody-stt/prosody.service /etc/systemd/user/prosody.service || true
        
        # Copy service file to user's systemd directory for auto-start
        if [ -n "$SUDO_USER" ]; then
            USER_HOME=$(getent passwd "$SUDO_USER" | cut -d: -f6)
            mkdir -p "$USER_HOME/.config/systemd/user/"
            cp /usr/share/prosody-stt/prosody.service "$USER_HOME/.config/systemd/user/" || true
            chown -R "$SUDO_USER:$SUDO_USER" "$USER_HOME/.config/systemd/user/prosody.service" || true
            
            # Create a flag file to enable on first login
            mkdir -p "$USER_HOME/.config/prosody/"
            touch "$USER_HOME/.config/prosody/.enable-on-login"
            chown -R "$SUDO_USER:$SUDO_USER" "$USER_HOME/.config/prosody/" || true
        fi
        
        echo ""
        echo "âœ“ Prosody has been installed!"
        echo ""
        echo "To start using Prosody:"
        echo "  1. Run 'prosody' to start it now, OR"
        echo "  2. Log out and back in (it will auto-start)"
        echo ""
        echo "Usage:"
        echo "  - Double-tap Ctrl to start/stop recording"
        echo "  - Double-tap Escape to cancel recording"
        echo ""
        echo "To manage Prosody:"
        echo "  - Check status: systemctl --user status prosody"
        echo "  - Stop: systemctl --user stop prosody"
        echo "  - Disable auto-start: systemctl --user disable prosody"
        echo ""
        echo "Note: First run will download the Whisper model (~140MB)"
        ;;
esac

#DEBHELPER#

exit 0